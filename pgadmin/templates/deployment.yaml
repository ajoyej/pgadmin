apiVersion: extensions/v1beta1
kind: Deployment
metadata:
  name: pgadmin
  labels:
    app: pgadmin
  annotations:
    authproxy.stakater.com/enabled: "true"
    authproxy.stakater.com/upstream-url: "https://127.0.0.1:80"
    authproxy.stakater.com/target-port: "3000"
    authproxy.stakater.com/source-service-name: pgadmin
    authproxy.stakater.com/image-name: quay.io/gambol99/keycloak-proxy
    authproxy.stakater.com/image-tag: v2.1.1
    authproxy.stakater.com/client-id: pgadmin
    authproxy.stakater.com/client-secret: "$(CLIENT_SECRET)"
    authproxy.stakater.com/discovery-url: https://keycloak-carbookdev.stackator.com/auth/realms/carbook
    authproxy.stakater.com/listen: "0.0.0.0:3000"
    authproxy.stakater.com/redirection-url: https://pgadmin-carbookdev.stackator.com/
    authproxy.stakater.com/resources: "uri=/*"
    authproxy.stakater.com/verbose: "true"
    authproxy.stakater.com/enable-logging: "true"
spec:
  replicas: 1
  selector:
    matchLabels:
      app: pgadmin
  template:
    metadata:
      labels:
        app: pgadmin
      annotations:
        fluentdConfiguration: >
          [
              {
                  "containers":
                  [
                      {
                          "expression": "/^\\S*\\s-\\s-\\s\\[(?<time>\\S*)[\\S\\s]*\\]\\s(?<message>[\\S\\s]*)/",
                          "expressionFirstLine": "/^\\:\\:f{4}:[0-9]+.[0-9]+\\.[0-9]+\\.[0-9]+/",
                          "timeFormat": "%d/%b/%Y:%H:%M:%S",
                          "containerName": "pgadmin"
                      },
                      {
                          "expression": "/^\\S*\\s(?<level>\\S*)\\s(?<class>\\S*)\\s(?<message>[\\S\\s]*)/",
                          "expressionFirstLine": "/^[0-9].[0-9]+e\\+[0-9]+/",
                          "timeFormat": "%Y-%m-%d %H:%M:%S,%L",
                          "containerName": "keycloak-proxy"
                      }
                  ]
              }
          ]
    spec:
      containers:
        - name: pgadmin
          image: dpage/pgadmin4:3.2
          env:
          - name: SERVER_MODE
            value: 'True'
          - name: PGADMIN_DEFAULT_USER
            valueFrom:
              configMapKeyRef:
                name: pgadmin-configmap
                key: pgadmin-username
          - name: PGADMIN_DEFAULT_EMAIL
            valueFrom:
              configMapKeyRef:
                name: pgadmin-configmap
                key: pgadmin-email
          - name: PGADMIN_DEFAULT_PASSWORD
            valueFrom:
              secretKeyRef:
                name: pgadmin-secrets
                key: pgadmin-password
          - name: CLIENT_SECRET
            valueFrom:
              secretKeyRef:
                name: pgadmin-secrets
                key: client-secret
          - name: PGADMIN_PORT
            value: "80"
          ports:
            - containerPort: 80
          volumeMounts:
          - name: pv-pgadmin-data
            mountPath: /var/lib/pgadmin
      volumes:
        - name: pv-pgadmin-data
          persistentVolumeClaim:
            # This disk must already exist.
            claimName: pvc-pgadmin-data
